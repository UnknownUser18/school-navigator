<h1>Nawigacja</h1>
<form [formGroup]="navigationForm">
  <label>
    Punkt startowy
    <div [class.error]="navigationForm.get('destinationPlace')?.invalid && navigationForm.get('destinationPlace')?.touched">
      <fa-icon [icon]="faSearch" />
      <input type="text" placeholder="np. Sala 101" formControlName="startingPlace" name="startPlace" required (input)="getStartingPlaceSuggestions()" (blur)="checkIfCanNavigate()">
    </div>
  </label>
  <label>
    Punkt docelowy
    <div [class.error]="navigationForm.get('startingPlace')?.invalid && navigationForm.get('startingPlace')?.touched">
      <fa-icon [icon]="faLocationDot" />
      <input type="text" placeholder="np. Toaleta" formControlName="destinationPlace" name="endPlace" required (input)="getDestinationPlaceSuggestions()" (blur)="checkIfCanNavigate()">
    </div>
  </label>
</form>
<div class="storey-chips">
  @for (storey of storeys; track storey.value) {
    <chip [isSelected]="selectedStorey() === storey.value" (click)="selectedStorey.set(storey.value)" [attr.aria-label]="storey.ariaLabel">
      {{ storey.label }}
    </chip>
  }
</div>
<div class="map-container">
  <ko-stage [config]="mapConfig" (wheel)="mouseZoom($event)" #map (touchstart)="onPinchStart($event)" (touchmove)="onPinchMove($event)" (touchend)="onPinchEnd($event)">
    <ko-layer>
      <ko-image [config]="mapImage" />
      @let navigationPath = path();
      @if (navigationPath && navigationPath.length > 1) {
        <ko-line [config]="{
          points : navigationPath,
          stroke : 'blue',
          strokeWidth : 4,
          lineCap : 'round',
          lineJoin : 'round',
          tension : 0.5
        }" />
      }
      @for (point of points(); track point.id) {
        <ko-circle [config]="{
        x : point.x_coordinate,
        y : point.y_coordinate,
        radius : 8,
        fill : 'red'
      }" (click)="selectedPoint.set(point)" (touchstart)="selectedPoint.set(point)" [tooltipMap]="tooltip" />
      }
    </ko-layer>
  </ko-stage>
</div>

@if (maneuvers()) {
  <ul class="maneuver-list">
    @for (maneuver of maneuvers(); track $index) {
      <li>
        <div class="icon">
          @switch (maneuver.instruction) {
            @case ('straight') {
              <fa-icon [icon]="faArrowUp" />
            }
            @case ('down') {
              <fa-icon [icon]="faStairs" />
            }
            @case ('up') {
              <fa-icon [icon]="faStairs" />
            }
            @case ('left') {
              <fa-icon [icon]="faArrowLeft" />
            }
            @case ('right') {
              <fa-icon [icon]="faArrowRight" />
            }
          }
        </div>
        <h3>
          @switch (maneuver.instruction) {
            @case ('straight') {
              Idź prosto {{ maneuver.distance.toFixed(2) }} metrów
            }
            @case ('down') {
              Zejdź o piętro niżej
            }
            @case ('up') {
              Wejdź o piętro wyżej
            }
            @case ('left') {
              Skręć w lewo
            }
            @case ('right') {
              Skręć w prawo
            }
          }
        </h3>
      </li>
      @if ($last) {
        <li>
          <div class="icon">
            <fa-icon [icon]="faFlagCheckered" />
          </div>
          <h3>Dotarłeś do celu!</h3>
        </li>
      }
    }
  </ul>
}


<tooltip #tooltip>
  @let point = selectedPoint();
  @if (point) {
    <div class="tooltip-content">
      <h2>

      </h2>
      @if ('room_number' in point) {
        Sala {{ point.room_number }}
      } @else if ('exit_name' in point) {
        Wyjście {{ point.exit_name }}
      } @else if ('up_stair_id' in point) {
        Schody S{{ point.id }}
      } @else {
        Punkt {{ point.id }}
      }
      <p>{{ point.description }}</p>
      <button class="primary" (click)="setAsStaringPlace(point); tooltip.hide()">Ustaw jako punkt startowy</button>
      <button class="secondary" (click)="setAsDestinationPlace(point); tooltip.hide()">Ustaw jako punkt docelowy</button>
    </div>
  } @else {
    <div class="tooltip-content">
      <p>Brak informacji o punkcie</p>
    </div>
  }
</tooltip>

@if (startingPlaceSuggestions()) {
  <div class="suggestions-backdrop starting" (click)="clearStartingPlaceSuggestions()">
    <ul>
      @for (suggestion of startingPlaceSuggestions(); track $index) {
        <li (click)="selectStartingPlaceSuggestion(suggestion)" matRipple [matRippleColor]="'var(--background-ripple)'">
          <b>@switch (suggestion.type) {
            @case ('room') {
              Sala
            }
            @case ('exit') {
              Wyjście
            }
            @case ('staircase') {
              Schody
            }
          }</b>
          <p>{{ suggestion.name }}</p>
          <i>{{ suggestion.description }}</i>
        </li>
      }
    </ul>
  </div>
}

@if (destinationPlaceSuggestions()) {
  <div class="suggestions-backdrop destination" (click)="clearDestinationPlaceSuggestions()">
    <ul>
      @for (suggestion of destinationPlaceSuggestions(); track $index) {
        <li (click)="selectDestinationPlaceSuggestion(suggestion)" matRipple [matRippleColor]="'var(--background-ripple)'">
          <b>@switch (suggestion.type) {
            @case ('room') {
              Sala
            }
            @case ('exit') {
              Wyjście
            }
            @case ('staircase') {
              Schody
            }
          }</b>
          <p>{{ suggestion.name }}</p>
          <i>{{ suggestion.description }}</i>
        </li>
      }
    </ul>
  </div>
}